# Mindfly PRD (V1) — Traceability Matrix

This matrix links each **security-critical V1 requirement** to the code, automated tests, and (when unavoidable) manual QA steps. The goal is to make PRD drift obvious and enforceable.

**Legend**

- **Code**: implementation entry points (not necessarily exhaustive).
- **Tests**: automated verification (unit/integration/e2e).
- **Manual QA**: required when the flow depends on real OS UI/security surfaces (OAuth sheets, Keychain prompts, installers).

| Requirement ID | PRD Ref        | Requirement (V1)                                                                                                                                      | Code file(s)                                                                                                                                                                                                                                                                      | Test(s)                                                                                                                                                                                                                                                                          | Manual QA                                                                                                                                                                                   |
| -------------- | -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| MF-V1-SEC-001  | §12.3          | Gateway is unusable without a valid auth token (loopback + bearer token).                                                                             | `src/gateway/auth.ts`<br />`src/gateway/server/ws-connection/message-handler.ts`<br />`src/gateway/openai-http.ts`<br />`src/gateway/openresponses-http.ts`                                                                                                                       | `src/security/mindfly-v1-security.spec.test.ts`<br />`src/gateway/auth.test.ts`<br />`src/gateway/server.auth.e2e.test.ts`                                                                                                                                                       | Try connecting with missing/invalid token → denied; valid token → allowed.                                                                                                                  |
| MF-V1-SEC-002  | §12.3, §13.1   | Tool subprocesses must not inherit gateway auth secrets via environment variables (prevents accidental token leakage into `exec`).                    | `src/agents/bash-tools.exec.ts`<br />`src/security/sensitive-env.ts`                                                                                                                                                                                                              | `src/security/mindfly-v1-security.spec.test.ts`                                                                                                                                                                                                                                  | Run an `exec` command that prints env; verify gateway token vars are absent unless explicitly provided.                                                                                     |
| MF-V1-SEC-003  | §13.1          | Approvals are **default-deny**: if no decision arrives before timeout, the action is denied and logged as a system event.                             | `src/agents/bash-tools.exec.ts`<br />`src/infra/system-events.ts`                                                                                                                                                                                                                 | `src/agents/bash-tools.exec.approval-id.test.ts` (timeout case)                                                                                                                                                                                                                  | Trigger an approval prompt and do nothing until it expires → verify it is denied (no command runs) and the UI shows a denial event.                                                         |
| MF-V1-SEC-006  | §13.5          | File tools (`read`/`write`/`edit`/`apply_patch`) require approval on first path; **allow-always** persists a directory glob to `tool-approvals.json`. | `src/agents/tool-approvals.ts`<br />`src/infra/tool-approvals.ts`<br />`src/infra/tool-approvals-session.ts`<br />`src/agents/pi-tools.ts`<br />`src/gateway/tool-approval-manager.ts`<br />`src/gateway/server-methods/tool-approval.ts`<br />`ui/src/ui/views/tool-approval.ts` | `src/security/mindfly-v1-tool-approvals.spec.test.ts`                                                                                                                                                                                                                            | Attempt `write` in a fresh session → prompt; **Allow once** → subsequent writes in same folder allowed in-session; **Always allow** → new session skips prompt for that folder.             |
| MF-V1-SEC-004  | §12.6          | Tool-returned external content is wrapped with explicit untrusted boundaries before it can influence agent reasoning (prompt injection defense).      | `src/security/external-content.ts`<br />`src/agents/tools/browser-tool.ts`<br />`src/agents/tools/web-fetch.ts`<br />`src/agents/tools/web-search.ts`<br />`src/agents/pi-tools.read.ts`<br />`src/config/types.tools.ts`<br />`src/config/zod-schema.agent-runtime.ts`           | `src/security/external-content.test.ts`<br />`src/agents/tools/browser-tool.test.ts` (wrapping)<br />`src/agents/tools/web-tools.fetch.test.ts` (wrapping)<br />`src/agents/tools/web-search.wrap-external-content.test.ts`<br />`src/security/mindfly-v1-security.spec.test.ts` | Run `browser.snapshot`, `web_fetch`, `web_search`, and `read` and confirm the output includes `<<<EXTERNAL_UNTRUSTED_CONTENT>>>…<<<END_EXTERNAL_UNTRUSTED_CONTENT>>>` with a warning block. |
| MF-V1-SEC-005  | §12.4.1 (note) | `browser.act:evaluate` is blocked when `browser.evaluateEnabled=false` (high-risk surface).                                                           | `src/browser/routes/agent.act.ts`<br />`src/browser/config.ts`                                                                                                                                                                                                                    | `src/browser/server.agent-contract-form-layout-act-commands.test.ts`                                                                                                                                                                                                             | Set `browser.evaluateEnabled=false`, attempt `act` evaluate → verify 403/denied.                                                                                                            |
| MF-V1-SEC-007  | §13.5          | Browser tool requires approval **per session** (separate grants for browser read vs control); `evaluate` should always ask.                           | `src/agents/tool-approvals.ts`<br />`src/agents/tools/browser-tool.ts`<br />`src/infra/tool-approvals-session.ts`<br />`src/gateway/tool-approval-manager.ts`<br />`src/gateway/server-methods/tool-approval.ts`<br />`ui/src/ui/views/tool-approval.ts`                          | `src/agents/tools/browser-tool.test.ts`                                                                                                                                                                                                                                          | In a fresh session: first `browser` read prompts, subsequent reads do not; first `browser` control prompts, subsequent control actions do not; `evaluate` prompts every time.               |
| MF-V1-SEC-008  | §12.1          | Auth-profiles secrets are migrated to OS secure store in v1; `auth-profiles.json` stores only `secure:` refs (no plaintext secrets).                  | `src/agents/auth-profiles/secure-store.ts`<br />`src/agents/auth-profiles/store.ts`<br />`src/infra/secure-store.ts`<br />`src/security/storage-crypto.ts`                                                                                                                    | `src/security/mindfly-v1-secure-store-migration.spec.test.ts`<br />`src/agents/auth-profiles/secure-store.test.ts`                                                                                                                                                              | Inspect `~/.openclaw/agents/main/auth-profiles.json` after adding a key: it should contain only `secure:` refs; secrets live in Keychain / Credential Manager.                             |

## Manual QA Checklist

See `docs/prd-consumer-app.v1-manual-qa.md`.
